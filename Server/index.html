<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <title>Logs</title>
  <style type="text/css">
    table {
      table-layout:fixed;
    }
    table td {
      overflow-y: visible;
      overflow-wrap: break-word;
    }
    .string { 
      color: green; 
    }
    .number { 
      color: darkorange; 
    }
    .boolean {
     color: blue; 
   }
   .null { 
    color: magenta; 
  }
  .key { 
    color: black;
  }
</style>
</head>
<body>
  <table id ="table" class="table small">
    <thead>
      <tr>
        <th scope="col" width="45%">Response</th>
        <th scope="col" width="15%">HTTP Body</th>
        <th scope="col" width="15%">Url</th>
        <th scope="col" width="5%">Date</th>
        <th scope="col" width="5%">Status Code</th>
        <th scope="col" width="5%">Method</th>
        <th scope="col" width="5%">User Agent</th>
        <th scope="col" width="5%">Authorize</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    $(function () {
      var socket = io('http://localhost:3000');
      socket.on('emit', function(msg){
        var ids = [];
        $('#table tr').each(function(){
          ids.push( $(this).attr('data-id') );
        });
        if( $.inArray(msg.id,ids) != -1 ) {
          $('.'+ msg.id).html('');
          $('.'+ msg.id).append(
            '<td width="45%"><pre>'     + syntaxHighlight(msg.data)  + '</pre></td>'
            + '<td width="15%">'        + decodeURI(msg.http_body)   + '</td>'
            + '<td width="15"><a href=' + msg.url                    + ' target="_blank">' + msg.url + '</url></td>'
            + '<td width="5%">'         + msg.date                   + '</td>'
            + '<td width="5%">'         + msg.status_code            + '</td>'
            + '<td width="5%">'         + msg.method                 + '</td>'
            + '<td width="5%">'         + msg.user_agent             + '</td>'
            + '<td width="5%">'         + msg.authorize              + '</td>'
            );
        } else {
          $('#table > tbody:last-child').append(
            '<tr data-id="'             + msg.id                    + '" class="'         + msg.id +  '" >'
            + '<td width="45%"><pre>'   + syntaxHighlight(msg.data) + '</pre></td>'
            + '<td width="15%">'        + decodeURI(msg.http_body)  + '</td>'
            + '<td width="15"><a href=' + msg.url                   + ' target="_blank">' + msg.url + '</url></td>'
            + '<td width="5%">'         + msg.date                  + '</td>'
            + '<td width="5%">'         + msg.status_code           + '</td>'
            + '<td width="5%">'         + msg.method                + '</td>'
            + '<td width="5%">'         + msg.user_agent            + '</td>'
            + '<td width="5%">'         + msg.authorize             + '</td>'
            + '</tr>'
            );
        }
      });
    });

    function syntaxHighlight(json) {
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'key';
          } else {
            cls = 'string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'boolean';
        } else if (/null/.test(match)) {
          cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }
  </script>
</body>
</html>
